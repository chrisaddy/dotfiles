#!/usr/bin/env bash
#
# theme-switch - Switch color themes across all configured applications
#
# Usage:
#   theme-switch <theme-name>    Switch to a theme
#   theme-switch --list          List available themes
#   theme-switch --current       Show current theme
#   theme-switch --help          Show this help
#

set -euo pipefail

DOTFILES="${DOTFILES:-$HOME/dotfiles}"
THEMES_DIR="$DOTFILES/themes"
CURRENT_THEME_FILE="$DOTFILES/theme"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

info() { echo -e "${BLUE}==>${NC} $1"; }
success() { echo -e "${GREEN}==>${NC} $1"; }
warn() { echo -e "${YELLOW}==>${NC} $1"; }
error() { echo -e "${RED}==>${NC} $1" >&2; }

usage() {
    cat <<EOF
Usage: theme-switch <theme-name>

Commands:
    <theme-name>    Switch to the specified theme
    --list, -l      List available themes
    --current, -c   Show current theme
    --help, -h      Show this help message

Examples:
    theme-switch tokyonight
    theme-switch cool-ice
    theme-switch --list
EOF
}

list_themes() {
    info "Available themes:"
    for theme_file in "$THEMES_DIR"/*.toml; do
        [[ -f "$theme_file" ]] || continue
        theme_name=$(basename "$theme_file" .toml)
        if [[ -f "$CURRENT_THEME_FILE" ]] && [[ "$(cat "$CURRENT_THEME_FILE")" == "$theme_name" ]]; then
            echo -e "  ${GREEN}* $theme_name${NC} (current)"
        else
            echo "    $theme_name"
        fi
    done
}

current_theme() {
    if [[ -f "$CURRENT_THEME_FILE" ]]; then
        cat "$CURRENT_THEME_FILE"
    else
        echo "No theme set"
    fi
}

# Parse TOML value - simple parser for our use case
get_toml_value() {
    local file="$1"
    local key="$2"
    grep -E "^${key}[[:space:]]*=" "$file" | head -1 | sed -E 's/^[^=]+=[[:space:]]*"([^"]*)".*/\1/'
}

# Generate Ghostty config
generate_ghostty() {
    local theme_file="$1"
    local config_file="$DOTFILES/ghostty/.config/ghostty/config"

    info "Updating Ghostty config..."

    # Read colors from theme
    local bg=$(get_toml_value "$theme_file" "bg")
    local fg=$(get_toml_value "$theme_file" "fg")
    local cursor=$(get_toml_value "$theme_file" "cursor")
    local selection=$(get_toml_value "$theme_file" "selection")

    # Terminal colors
    local black=$(get_toml_value "$theme_file" "black")
    local red=$(get_toml_value "$theme_file" "red")
    local green=$(get_toml_value "$theme_file" "green")
    local yellow=$(get_toml_value "$theme_file" "yellow")
    local blue=$(get_toml_value "$theme_file" "blue")
    local magenta=$(get_toml_value "$theme_file" "magenta")
    local cyan=$(get_toml_value "$theme_file" "cyan")
    local white=$(get_toml_value "$theme_file" "white")
    local bright_black=$(get_toml_value "$theme_file" "bright_black")
    local bright_red=$(get_toml_value "$theme_file" "bright_red")
    local bright_green=$(get_toml_value "$theme_file" "bright_green")
    local bright_yellow=$(get_toml_value "$theme_file" "bright_yellow")
    local bright_blue=$(get_toml_value "$theme_file" "bright_blue")
    local bright_magenta=$(get_toml_value "$theme_file" "bright_magenta")
    local bright_cyan=$(get_toml_value "$theme_file" "bright_cyan")
    local bright_white=$(get_toml_value "$theme_file" "bright_white")

    # Fallback for terminal colors if not in [terminal] section
    [[ -z "$black" ]] && black=$(get_toml_value "$theme_file" "bg_dark")
    [[ -z "$white" ]] && white=$(get_toml_value "$theme_file" "fg_dark")
    [[ -z "$bright_black" ]] && bright_black=$(get_toml_value "$theme_file" "fg_muted")
    [[ -z "$bright_white" ]] && bright_white="$fg"
    [[ -z "$cursor" ]] && cursor="$fg"
    [[ -z "$selection" ]] && selection=$(get_toml_value "$theme_file" "bg_light")

    # Write Ghostty config
    cat > "$config_file" <<EOF
# Theme: $(basename "$theme_file" .toml)
# Generated by theme-switch

font-size = 16
cursor-style = block
shell-integration = zsh
shell-integration-features = cursor,no-title
background-opacity = 0.9
macos-titlebar-style = transparent

window-position-x = 5
window-position-y = 5
window-width = 85
window-height = 24

# Colors
background = ${bg}
foreground = ${fg}
cursor-color = ${cursor}
selection-background = ${selection}
selection-foreground = ${fg}

palette = 0=${black}
palette = 1=${red}
palette = 2=${green}
palette = 3=${yellow}
palette = 4=${blue}
palette = 5=${magenta}
palette = 6=${cyan}
palette = 7=${white}
palette = 8=${bright_black}
palette = 9=${bright_red}
palette = 10=${bright_green}
palette = 11=${bright_yellow}
palette = 12=${bright_blue}
palette = 13=${bright_magenta}
palette = 14=${bright_cyan}
palette = 15=${bright_white}
EOF
}

# Generate Tmux config
generate_tmux() {
    local theme_file="$1"
    local config_file="$DOTFILES/tmux/.tmux.conf"

    info "Updating Tmux config..."

    # Read colors
    local bg=$(get_toml_value "$theme_file" "bg")
    local bg_dark=$(get_toml_value "$theme_file" "bg_dark")
    local bg_light=$(get_toml_value "$theme_file" "bg_light")
    local fg=$(get_toml_value "$theme_file" "fg")
    local fg_dark=$(get_toml_value "$theme_file" "fg_dark")
    local fg_muted=$(get_toml_value "$theme_file" "fg_muted")
    local accent=$(get_toml_value "$theme_file" "accent")
    local border=$(get_toml_value "$theme_file" "border")
    local selection=$(get_toml_value "$theme_file" "selection")

    [[ -z "$border" ]] && border="$bg_light"
    [[ -z "$selection" ]] && selection="$bg_light"

    cat > "$config_file" <<EOF
##### Theme: $(basename "$theme_file" .toml)
##### Generated by theme-switch

##### Core options
set -g prefix C-Space
unbind C-b

set -g base-index 1
set -g pane-base-index 1
set -g mouse on
set -g escape-time 0
set -g clock-mode-style 24
set -g renumber-windows on
set -g set-clipboard on
setw -g mode-keys vi

# Prefer Nushell as default command (login shell)
set -g default-command "nu -l"

##### Theme colors
set -g status-style "bg=${bg_dark},fg=${fg_dark}"
set -g status-left "#[bg=${accent},fg=${bg},bold] #S #[bg=${bg_dark},fg=${accent}]"
set -g status-right "#[fg=${fg_muted}]%H:%M #[fg=${accent}]│ #[fg=${fg_dark}]%Y-%m-%d "
set -g status-left-length 30
set -g status-right-length 50

# Window status
set -g window-status-format "#[fg=${fg_muted}] #I:#W "
set -g window-status-current-format "#[bg=${bg_light},fg=${accent},bold] #I:#W "
set -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=${border}"
set -g pane-active-border-style "fg=${accent}"

# Messages
set -g message-style "bg=${selection},fg=${fg}"
set -g message-command-style "bg=${selection},fg=${fg}"

# Mode (copy mode, etc)
set -g mode-style "bg=${selection},fg=${fg}"

##### Environment for tmux-fzf (TPM install path)
set-environment -g TMUX_FZF_OPTIONS "-p -w 90% -h 90% -m"
set-environment -g TMUX_FZF_PLUGIN_DIR "~/.tmux/plugins/tmux-fzf"

##### Key bindings
# Sessions / clients
bind Space choose-session
bind * list-clients
bind C-d detach-client
bind-key R command-prompt -I "#S" "rename-session '%%'"
bind n command-prompt "new-session -s '%%'"

# Windows
bind C new-window -c "\$HOME"
bind c new-window -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind / split-window -h -c "#{pane_current_path}"
bind C-h previous-window
bind C-l next-window
bind w choose-window
bind-key r command-prompt -I "#S" "rename-window '%%'"
bind -r < swap-window -t -1
bind -r > swap-window -t +1

# Pane navigation (vim-style, no prefix needed)
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

##### Plugins (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sainnhe/tmux-fzf'

run '~/.tmux/plugins/tpm/tpm'
EOF
}

# Generate Neovim theme
generate_nvim() {
    local theme_file="$1"
    local theme_name=$(basename "$theme_file" .toml)
    local themes_dir="$DOTFILES/nvim/.config/nvim/lua/themes"
    local palette_file="$themes_dir/palette.lua"

    info "Updating Neovim theme..."

    mkdir -p "$themes_dir"

    # Read all colors
    local bg=$(get_toml_value "$theme_file" "bg")
    local bg_dark=$(get_toml_value "$theme_file" "bg_dark")
    local bg_light=$(get_toml_value "$theme_file" "bg_light")
    local fg=$(get_toml_value "$theme_file" "fg")
    local fg_dark=$(get_toml_value "$theme_file" "fg_dark")
    local fg_muted=$(get_toml_value "$theme_file" "fg_muted")
    local accent=$(get_toml_value "$theme_file" "accent")
    local secondary=$(get_toml_value "$theme_file" "secondary")
    local red=$(get_toml_value "$theme_file" "red")
    local orange=$(get_toml_value "$theme_file" "orange")
    local yellow=$(get_toml_value "$theme_file" "yellow")
    local green=$(get_toml_value "$theme_file" "green")
    local cyan=$(get_toml_value "$theme_file" "cyan")
    local blue=$(get_toml_value "$theme_file" "blue")
    local magenta=$(get_toml_value "$theme_file" "magenta")
    local border=$(get_toml_value "$theme_file" "border")
    local selection=$(get_toml_value "$theme_file" "selection")
    local cursor=$(get_toml_value "$theme_file" "cursor")

    # Fallbacks
    [[ -z "$border" ]] && border="$bg_light"
    [[ -z "$selection" ]] && selection="$bg_light"
    [[ -z "$cursor" ]] && cursor="$fg"
    [[ -z "$orange" ]] && orange="$yellow"

    cat > "$palette_file" <<EOF
-- Theme: ${theme_name}
-- Generated by theme-switch

local M = {}

M.name = "${theme_name}"

M.colors = {
    bg = "${bg}",
    bg_dark = "${bg_dark}",
    bg_light = "${bg_light}",
    fg = "${fg}",
    fg_dark = "${fg_dark}",
    fg_muted = "${fg_muted}",
    accent = "${accent}",
    secondary = "${secondary}",
    red = "${red}",
    orange = "${orange}",
    yellow = "${yellow}",
    green = "${green}",
    cyan = "${cyan}",
    blue = "${blue}",
    magenta = "${magenta}",
    border = "${border}",
    selection = "${selection}",
    cursor = "${cursor}",
}

function M.apply()
    local c = M.colors

    vim.cmd("highlight clear")
    vim.o.background = "dark"
    vim.g.colors_name = "${theme_name}"

    local highlights = {
        -- UI
        Normal = { fg = c.fg, bg = c.bg },
        NormalFloat = { fg = c.fg, bg = c.bg_dark },
        FloatBorder = { fg = c.border, bg = c.bg_dark },
        Cursor = { fg = c.bg, bg = c.cursor },
        CursorLine = { bg = c.bg_light },
        CursorLineNr = { fg = c.accent, bold = true },
        LineNr = { fg = c.fg_muted },
        SignColumn = { bg = c.bg },
        ColorColumn = { bg = c.bg_dark },
        Visual = { bg = c.selection },
        VisualNOS = { bg = c.selection },
        Search = { fg = c.bg, bg = c.yellow },
        IncSearch = { fg = c.bg, bg = c.orange },

        -- Popup menu
        Pmenu = { fg = c.fg, bg = c.bg_dark },
        PmenuSel = { fg = c.fg, bg = c.selection },
        PmenuSbar = { bg = c.bg_light },
        PmenuThumb = { bg = c.accent },

        -- Messages
        ErrorMsg = { fg = c.red },
        WarningMsg = { fg = c.yellow },
        MoreMsg = { fg = c.cyan },
        Question = { fg = c.cyan },

        -- Splits and tabs
        VertSplit = { fg = c.border },
        WinSeparator = { fg = c.border },
        TabLine = { fg = c.fg_muted, bg = c.bg_dark },
        TabLineSel = { fg = c.fg, bg = c.bg },
        TabLineFill = { bg = c.bg_dark },

        -- Statusline
        StatusLine = { fg = c.fg, bg = c.bg_dark },
        StatusLineNC = { fg = c.fg_muted, bg = c.bg_dark },

        -- Syntax
        Comment = { fg = c.fg_muted, italic = true },
        Constant = { fg = c.orange },
        String = { fg = c.green },
        Character = { fg = c.green },
        Number = { fg = c.orange },
        Boolean = { fg = c.orange },
        Float = { fg = c.orange },
        Identifier = { fg = c.fg },
        Function = { fg = c.blue },
        Statement = { fg = c.magenta },
        Conditional = { fg = c.magenta },
        Repeat = { fg = c.magenta },
        Label = { fg = c.cyan },
        Operator = { fg = c.fg_dark },
        Keyword = { fg = c.magenta },
        Exception = { fg = c.magenta },
        PreProc = { fg = c.cyan },
        Include = { fg = c.magenta },
        Define = { fg = c.magenta },
        Macro = { fg = c.cyan },
        PreCondit = { fg = c.cyan },
        Type = { fg = c.cyan },
        StorageClass = { fg = c.magenta },
        Structure = { fg = c.cyan },
        Typedef = { fg = c.cyan },
        Special = { fg = c.secondary },
        SpecialChar = { fg = c.secondary },
        Tag = { fg = c.accent },
        Delimiter = { fg = c.fg_dark },
        SpecialComment = { fg = c.fg_muted },
        Debug = { fg = c.red },
        Underlined = { underline = true },
        Error = { fg = c.red },
        Todo = { fg = c.bg, bg = c.yellow, bold = true },

        -- Diff
        DiffAdd = { bg = "#1a332a" },
        DiffChange = { bg = "#1a2a33" },
        DiffDelete = { bg = "#331a1a" },
        DiffText = { bg = "#1a3a4a" },

        -- Git signs
        GitSignsAdd = { fg = c.green },
        GitSignsChange = { fg = c.yellow },
        GitSignsDelete = { fg = c.red },

        -- Diagnostics
        DiagnosticError = { fg = c.red },
        DiagnosticWarn = { fg = c.yellow },
        DiagnosticInfo = { fg = c.cyan },
        DiagnosticHint = { fg = c.accent },
        DiagnosticUnderlineError = { undercurl = true, sp = c.red },
        DiagnosticUnderlineWarn = { undercurl = true, sp = c.yellow },
        DiagnosticUnderlineInfo = { undercurl = true, sp = c.cyan },
        DiagnosticUnderlineHint = { undercurl = true, sp = c.accent },

        -- Treesitter
        ["@variable"] = { fg = c.fg },
        ["@variable.builtin"] = { fg = c.red },
        ["@variable.parameter"] = { fg = c.fg },
        ["@constant"] = { fg = c.orange },
        ["@constant.builtin"] = { fg = c.orange },
        ["@module"] = { fg = c.cyan },
        ["@label"] = { fg = c.cyan },
        ["@string"] = { fg = c.green },
        ["@character"] = { fg = c.green },
        ["@number"] = { fg = c.orange },
        ["@boolean"] = { fg = c.orange },
        ["@type"] = { fg = c.cyan },
        ["@type.builtin"] = { fg = c.cyan },
        ["@attribute"] = { fg = c.cyan },
        ["@property"] = { fg = c.accent },
        ["@function"] = { fg = c.blue },
        ["@function.builtin"] = { fg = c.blue },
        ["@function.method"] = { fg = c.blue },
        ["@constructor"] = { fg = c.cyan },
        ["@keyword"] = { fg = c.magenta },
        ["@keyword.function"] = { fg = c.magenta },
        ["@keyword.return"] = { fg = c.magenta },
        ["@keyword.operator"] = { fg = c.magenta },
        ["@keyword.import"] = { fg = c.magenta },
        ["@keyword.conditional"] = { fg = c.magenta },
        ["@keyword.repeat"] = { fg = c.magenta },
        ["@operator"] = { fg = c.fg_dark },
        ["@punctuation"] = { fg = c.fg_dark },
        ["@punctuation.bracket"] = { fg = c.fg_dark },
        ["@punctuation.delimiter"] = { fg = c.fg_dark },
        ["@comment"] = { fg = c.fg_muted, italic = true },
        ["@tag"] = { fg = c.accent },
        ["@tag.attribute"] = { fg = c.secondary },
        ["@tag.delimiter"] = { fg = c.fg_dark },
    }

    for group, opts in pairs(highlights) do
        vim.api.nvim_set_hl(0, group, opts)
    end
end

return M
EOF

    # Create/update the colors.lua plugin
    local colors_plugin="$DOTFILES/nvim/.config/nvim/lua/plugins/colors.lua"
    cat > "$colors_plugin" <<EOF
-- Theme loader
-- Generated by theme-switch

return {
    "rktjmp/lush.nvim",  -- Optional dependency for custom themes
    lazy = false,
    priority = 1000,
    config = function()
        local ok, palette = pcall(require, "themes.palette")
        if ok and palette.apply then
            palette.apply()
        else
            -- Fallback to tokyonight if custom theme fails
            vim.cmd([[colorscheme default]])
        end
    end,
}
EOF
}

# Generate Bat config
generate_bat() {
    local theme_file="$1"
    local config_dir="$DOTFILES/bat/.config/bat"
    local config_file="$config_dir/config"

    info "Updating Bat config..."

    mkdir -p "$config_dir"

    # Bat uses preset themes, we'll map to closest match
    # For custom themes, would need to generate .tmTheme file
    cat > "$config_file" <<EOF
# Theme: $(basename "$theme_file" .toml)
# Generated by theme-switch

--pager="less -FR"
--theme="base16"
--style="numbers,changes,header"
EOF
}

# Generate Starship config
generate_starship() {
    local theme_file="$1"
    local config_dir="$DOTFILES/starship/.config"
    local config_file="$config_dir/starship.toml"

    info "Updating Starship config..."

    mkdir -p "$config_dir"

    local accent=$(get_toml_value "$theme_file" "accent")
    local green=$(get_toml_value "$theme_file" "green")
    local red=$(get_toml_value "$theme_file" "red")
    local blue=$(get_toml_value "$theme_file" "blue")
    local magenta=$(get_toml_value "$theme_file" "magenta")
    local yellow=$(get_toml_value "$theme_file" "yellow")
    local cyan=$(get_toml_value "$theme_file" "cyan")
    local fg_muted=$(get_toml_value "$theme_file" "fg_muted")

    cat > "$config_file" <<EOF
# Theme: $(basename "$theme_file" .toml)
# Generated by theme-switch

add_newline = true

[character]
success_symbol = "[➜](bold ${green})"
error_symbol = "[➜](bold ${red})"

[directory]
style = "bold ${accent}"
truncation_length = 3
truncate_to_repo = true

[git_branch]
style = "bold ${magenta}"
symbol = " "

[git_status]
style = "bold ${yellow}"
ahead = "⇡\${count}"
behind = "⇣\${count}"
diverged = "⇕⇡\${ahead_count}⇣\${behind_count}"
modified = "!"
staged = "+"
untracked = "?"

[python]
style = "bold ${blue}"
symbol = " "

[rust]
style = "bold ${red}"
symbol = " "

[nodejs]
style = "bold ${green}"
symbol = " "

[lua]
style = "bold ${cyan}"
symbol = " "

[nix_shell]
style = "bold ${accent}"
symbol = " "

[cmd_duration]
style = "bold ${fg_muted}"
min_time = 2_000
EOF
}

# Generate Lazygit config
generate_lazygit() {
    local theme_file="$1"
    local config_dir="$DOTFILES/lazygit/.config/lazygit"
    local config_file="$config_dir/config.yml"

    info "Updating Lazygit config..."

    mkdir -p "$config_dir"

    local accent=$(get_toml_value "$theme_file" "accent")
    local border=$(get_toml_value "$theme_file" "border")
    local selection=$(get_toml_value "$theme_file" "selection")
    local fg=$(get_toml_value "$theme_file" "fg")
    local red=$(get_toml_value "$theme_file" "red")
    local green=$(get_toml_value "$theme_file" "green")
    local yellow=$(get_toml_value "$theme_file" "yellow")
    local magenta=$(get_toml_value "$theme_file" "magenta")

    [[ -z "$border" ]] && border=$(get_toml_value "$theme_file" "bg_light")
    [[ -z "$selection" ]] && selection=$(get_toml_value "$theme_file" "bg_light")

    cat > "$config_file" <<EOF
# Theme: $(basename "$theme_file" .toml)
# Generated by theme-switch

gui:
  theme:
    activeBorderColor:
      - "${accent}"
      - bold
    inactiveBorderColor:
      - "${border}"
    optionsTextColor:
      - "${accent}"
    selectedLineBgColor:
      - "${selection}"
    cherryPickedCommitBgColor:
      - "${magenta}"
    cherryPickedCommitFgColor:
      - "${fg}"
    unstagedChangesColor:
      - "${red}"
    defaultFgColor:
      - "${fg}"
    searchingActiveBorderColor:
      - "${yellow}"
  nerdFontsVersion: "3"
EOF
}

# Reload running applications
reload_apps() {
    info "Reloading applications..."

    # Reload tmux if running
    if command -v tmux &>/dev/null && tmux list-sessions &>/dev/null; then
        tmux source-file "$DOTFILES/tmux/.tmux.conf" 2>/dev/null && \
            success "Tmux reloaded" || warn "Tmux reload failed"
    fi

    # Note: Ghostty requires restart
    warn "Ghostty requires restart to apply new theme"

    # Neovim - would need nvim-remote or similar
    warn "Restart Neovim to apply new theme (or :source lua/themes/palette.lua)"
}

switch_theme() {
    local theme_name="$1"
    local theme_file="$THEMES_DIR/${theme_name}.toml"

    if [[ ! -f "$theme_file" ]]; then
        error "Theme '$theme_name' not found"
        echo "Available themes:"
        list_themes
        exit 1
    fi

    info "Switching to theme: $theme_name"

    # Generate configs for each app
    generate_ghostty "$theme_file"
    generate_tmux "$theme_file"
    generate_nvim "$theme_file"
    generate_bat "$theme_file"
    generate_starship "$theme_file"
    generate_lazygit "$theme_file"

    # Save current theme
    echo "$theme_name" > "$CURRENT_THEME_FILE"

    # Reload apps
    reload_apps

    success "Theme switched to: $theme_name"
    echo ""
    echo "Apps updated:"
    echo "  - Ghostty (restart required)"
    echo "  - Tmux"
    echo "  - Neovim (restart or :luafile)"
    echo "  - Bat"
    echo "  - Starship"
    echo "  - Lazygit"
}

# Main
main() {
    # Check for themes directory
    if [[ ! -d "$THEMES_DIR" ]]; then
        error "Themes directory not found: $THEMES_DIR"
        echo "Create it with: mkdir -p $THEMES_DIR"
        exit 1
    fi

    case "${1:-}" in
        --help|-h|"")
            usage
            ;;
        --list|-l)
            list_themes
            ;;
        --current|-c)
            current_theme
            ;;
        *)
            switch_theme "$1"
            ;;
    esac
}

main "$@"
